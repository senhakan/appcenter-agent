<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <?define ProductName="AppCenter Agent" ?>
  <?define Manufacturer="AppCenter" ?>

  <!--
    Build variables (passed via candle.exe):
      -dProductVersion=0.1.3
      -dBuildDir=build
      -dSourceDir=.
  -->
  <Product
    Id="*"
    Name="$(var.ProductName)"
    Manufacturer="$(var.Manufacturer)"
    Language="1033"
    Version="$(var.ProductVersion)"
    UpgradeCode="DB6D7C49-3459-41EE-B750-B8167D576072">

    <Package InstallerVersion="500" Compressed="yes" InstallScope="perMachine" Platform="x64" />
    <MajorUpgrade DowngradeErrorMessage="A newer version of AppCenter Agent is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <!-- Public MSI properties for unattended/bootstrap installation.
         Default SERVER_URL is used when not passed on the command line. -->
    <Property Id="SERVER_URL" Secure="yes" Value="http://10.6.100.170:8000" />
    <Property Id="SECRET_KEY" Secure="yes" Hidden="yes" />

    <!-- Minimal UI with an extra dialog to capture SERVER_URL/SECRET_KEY in interactive installs. -->
    <UI>
      <UIRef Id="WixUI_Minimal" />
      <UIRef Id="WixUI_ErrorProgressText" />

      <Dialog Id="BootstrapDlg" Width="370" Height="270" Title="[ProductName] Setup">
        <Control Id="Title" Type="Text" X="15" Y="6" Width="340" Height="15" Transparent="yes" NoPrefix="yes"
          Text="Bootstrap Settings" />
        <Control Id="Desc" Type="Text" X="15" Y="23" Width="340" Height="28" Transparent="yes" NoPrefix="yes"
          Text="Enter the AppCenter Server URL. Secret Key is optional (leave empty to auto-register)." />

        <Control Id="ServerUrlLabel" Type="Text" X="15" Y="70" Width="100" Height="15" Text="Server URL:" />
        <Control Id="ServerUrlEdit" Type="Edit" X="120" Y="68" Width="235" Height="18" Property="SERVER_URL" />

        <Control Id="SecretLabel" Type="Text" X="15" Y="100" Width="100" Height="15" Text="Secret Key:" />
        <Control Id="SecretEdit" Type="Edit" X="120" Y="98" Width="235" Height="18" Property="SECRET_KEY" Password="yes" />

        <Control Id="Back" Type="PushButton" X="180" Y="243" Width="56" Height="17" Text="&amp;Back">
        </Control>
        <Control Id="Next" Type="PushButton" X="236" Y="243" Width="56" Height="17" Default="yes" Text="&amp;Next">
          <Condition Action="disable">SERVER_URL = ""</Condition>
          <Condition Action="enable">SERVER_URL &lt;&gt; ""</Condition>
        </Control>
        <Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="Cancel">
          <Publish Event="SpawnDialog" Value="CancelDlg">1</Publish>
        </Control>
      </Dialog>

      <!-- Insert BootstrapDlg into the WixUI_Minimal flow (WelcomeDlg -> ... -> VerifyReadyDlg).
           Important: MSI processes control events in ascending Order; for NewDialog, the first match wins.
           So we must publish our navigation earlier than the default WixUI events. -->
      <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="BootstrapDlg" Order="1">SERVER_URL = ""</Publish>
      <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg" Order="2">SERVER_URL &lt;&gt; ""</Publish>
      <Publish Dialog="BootstrapDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg" Order="1">1</Publish>
      <Publish Dialog="BootstrapDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg" Order="1">1</Publish>
    </UI>

    <Feature Id="MainFeature" Title="$(var.ProductName)" Level="1">
      <ComponentRef Id="cmpServiceExe" />
      <ComponentRef Id="cmpTrayExe" />
      <ComponentRef Id="cmpTrayCliExe" />
      <ComponentRef Id="cmpUpdateHelperExe" />
      <ComponentRef Id="cmpRemoteHelperExe" />
      <ComponentRef Id="cmpStoreUIExe" />
      <ComponentRef Id="cmpTrayAutoStart" />
      <ComponentRef Id="cmpConfigFile" />
      <ComponentRef Id="cmpDownloadsDir" />
      <ComponentRef Id="cmpLogsDir" />
      <ComponentRef Id="cmpBootstrapServerURL" />
      <ComponentRef Id="cmpBootstrapSecretKey" />
    </Feature>
  </Product>

  <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLFOLDER" Name="AppCenter" />
      </Directory>

      <Directory Id="CommonAppDataFolder">
        <Directory Id="APPDATAFOLDER" Name="AppCenter">
          <Directory Id="DOWNLOADSFOLDER" Name="downloads" />
          <Directory Id="LOGSFOLDER" Name="logs" />
        </Directory>
      </Directory>
    </Directory>
  </Fragment>

  <Fragment>
    <!-- Service -->
    <Component Id="cmpServiceExe" Guid="FD2A7E35-3D53-4DA2-A82E-B87E4BEB74C1" Directory="INSTALLFOLDER" Win64="yes">
      <File Id="filServiceExe" Source="$(var.BuildDir)\appcenter-service.exe" KeyPath="yes" />

      <ServiceInstall
        Id="svcInstall"
        Name="AppCenterAgent"
        DisplayName="AppCenterAgent"
        Description="AppCenter Agent Service"
        Type="ownProcess"
        Start="auto"
        ErrorControl="normal"
        Vital="yes" />

      <ServiceControl
        Id="svcControl"
        Name="AppCenterAgent"
        Start="install"
        Stop="both"
        Remove="uninstall"
        Wait="no" />
    </Component>

    <!-- Tray binaries -->
    <Component Id="cmpTrayExe" Guid="7C41837E-D0CE-4310-A3E6-367F9E0E9807" Directory="INSTALLFOLDER" Win64="yes">
      <File Id="filTrayExe" Source="$(var.BuildDir)\appcenter-tray.exe" KeyPath="yes" />
    </Component>

    <Component Id="cmpTrayCliExe" Guid="2FCDB2C7-2EEF-4548-8576-891F40AFCBBC" Directory="INSTALLFOLDER" Win64="yes">
      <File Id="filTrayCliExe" Source="$(var.BuildDir)\appcenter-tray-cli.exe" KeyPath="yes" />
    </Component>

    <Component Id="cmpUpdateHelperExe" Guid="6C7C0357-86F0-477C-B491-1D342DB74D8A" Directory="INSTALLFOLDER" Win64="yes">
      <File Id="filUpdateHelperExe" Source="$(var.BuildDir)\appcenter-update-helper.exe" KeyPath="yes" />
    </Component>

    <Component Id="cmpRemoteHelperExe" Guid="B9C7DF39-D8A0-4FEE-9324-5D07CC6352A8" Directory="INSTALLFOLDER" Win64="yes">
      <File Id="filRemoteHelperExe" Source="$(var.BuildDir)\rshelper.exe" KeyPath="yes" />
    </Component>

    <Component Id="cmpStoreUIExe" Guid="5FBB30D6-4231-4098-8CA7-BC6D1538D313" Directory="INSTALLFOLDER" Win64="yes">
      <File Id="filStoreUIExe" Source="$(var.BuildDir)\appcenter-store-ui.exe" KeyPath="yes" />
    </Component>

    <!-- Tray autostart for all users -->
    <Component Id="cmpTrayAutoStart" Guid="0F8EFE56-3518-4BE3-A9F6-9C81AB150510" Directory="INSTALLFOLDER" Win64="yes">
      <RegistryValue
        Root="HKLM"
        Key="Software\Microsoft\Windows\CurrentVersion\Run"
        Name="AppCenterTray"
        Type="string"
        Value="&quot;[INSTALLFOLDER]appcenter-tray.exe&quot;"
        KeyPath="yes" />
    </Component>

    <!-- ProgramData config -->
    <Component Id="cmpConfigFile" Guid="D3985A99-F1E2-42FA-85BD-7ADC1DD828F1" Directory="APPDATAFOLDER" NeverOverwrite="yes" Win64="yes">
      <!-- NeverOverwrite preserves local changes on upgrade/repair. -->
      <File
        Id="filConfig"
        Source="$(var.SourceDir)\configs\config.yaml.template"
        Name="config.yaml"
        KeyPath="yes" />
    </Component>

    <!-- Ensure runtime folders exist -->
    <Component Id="cmpDownloadsDir" Guid="64417B5A-E4E2-4E27-9770-25A8F381EBD8" Directory="DOWNLOADSFOLDER" Win64="yes">
      <CreateFolder />
      <RemoveFolder Id="rmDownloadsDir" On="uninstall" />
      <RegistryValue Root="HKLM" Key="Software\AppCenter\Agent" Name="DownloadsDir" Type="string" Value="1" KeyPath="yes" />
    </Component>

    <Component Id="cmpLogsDir" Guid="E8C451D5-FBAA-44B4-9950-99B787F6109C" Directory="LOGSFOLDER" Win64="yes">
      <CreateFolder />
      <RemoveFolder Id="rmLogsDir" On="uninstall" />
      <RegistryValue Root="HKLM" Key="Software\AppCenter\Agent" Name="LogsDir" Type="string" Value="1" KeyPath="yes" />
    </Component>

    <!-- Optional bootstrap overrides from MSI properties -->
    <Component Id="cmpBootstrapServerURL" Guid="7D3D8D68-20B3-4AD1-8B54-2D6A1A4EAAE7" Directory="INSTALLFOLDER" Win64="yes">
      <Condition>SERVER_URL &lt;&gt; ""</Condition>
      <RegistryValue
        Root="HKLM"
        Key="Software\AppCenter\Agent\Bootstrap"
        Name="ServerURL"
        Type="string"
        Value="[SERVER_URL]"
        KeyPath="yes" />
    </Component>

    <Component Id="cmpBootstrapSecretKey" Guid="4E4A43ED-D0F8-41A2-94D8-D38F34391E2A" Directory="INSTALLFOLDER" Win64="yes">
      <Condition>SECRET_KEY &lt;&gt; ""</Condition>
      <RegistryValue
        Root="HKLM"
        Key="Software\AppCenter\Agent\Bootstrap"
        Name="SecretKey"
        Type="string"
        Value="[SECRET_KEY]"
        KeyPath="yes" />
    </Component>
  </Fragment>
</Wix>
